# dvc.yaml

vars:
  - params.yaml: [data_splits, gold_pipeline]

stages:
  split_data:
    cmd: python src/data_split/split_data.py
    deps:
      - src/data_split/split_data.py
      - src/data_ingestion/data_loader.py
      - src/shared/utils.py
      - src/shared/config/config_logging.py
      - data/raw/flights.csv
    outs:
      - data/raw/train_validation_test/train.csv
      - data/raw/train_validation_test/validation.csv
      - data/raw/train_validation_test/test.csv

  bronze_pipeline:
    foreach: ${data_splits}
    do:
      cmd: python src/pipelines/bronze_pipeline.py ${item}.csv
      deps:
        - src/pipelines/bronze_pipeline.py
        - src/shared/utils.py
        - src/shared/config/config_logging.py
        - src/shared/config/config_bronze.py
        - src/data_ingestion/data_loader.py
        # --- Specific GE Dependencies ---
        - src/data_validation/ge_components.py
        - src/data_validation/expectations/bronze_expectations.py
        - data/raw/train_validation_test/${item}.csv
      outs:
        - data/bronze_data/processed/${item}.csv

  silver_pipeline:
    foreach: ${data_splits}
    do:
      cmd: python src/pipelines/silver_pipeline.py ${item}.csv
      deps:
        - src/pipelines/silver_pipeline.py
        - src/data_ingestion/data_loader.py
        - src/silver_data_preprocessing/
        - src/shared/utils.py
        - src/shared/config/config_logging.py
        - src/shared/config/config_silver.py
        # --- Specific GE Dependencies ---
        - src/data_validation/ge_components.py
        - src/data_validation/expectations/silver_expectations.py
        - data/bronze_data/processed/${item}.csv
      outs:
        - data/silver_data/processed/${item}.parquet

  gold_pipeline:
    cmd: python src/pipelines/gold_pipeline.py
    deps:
      - src/pipelines/gold_pipeline.py
      - src/gold_data_preprocessing/
      - src/data_ingestion/data_loader.py
      - src/shared/utils.py
      - src/shared/config/config_logging.py
      - src/shared/config/config_gold.py
      - data/silver_data/processed/train.parquet
      - data/silver_data/processed/validation.parquet
      - data/silver_data/processed/test.parquet
      - src/data_validation/expectations/gold_expectations.py
      - src/data_validation/ge_components.py
    params:
      - gold_pipeline.imputation
      - gold_pipeline.rare_category_grouping
      - gold_pipeline.outlier_handling
      - gold_pipeline.power_transformer
    outs:
      - data/gold_engineered_data/processed/train.parquet
      - data/gold_engineered_data/processed/validation.parquet
      - data/gold_engineered_data/processed/test.parquet
      - models/simple_imputer.json
      - models/categorical_encoder.joblib
      - models/gold_final_columns.json

  training_pipeline:
    cmd: python src/pipelines/training_pipeline.py train.parquet validation.parquet test.parquet
    deps:
      - src/pipelines/training_pipeline.py
      - src/data_ingestion/data_loader.py
      - src/model_evaluation/evaluation.py
      - src/gold_data_preprocessing/power_transformer.py
      - src/gold_data_preprocessing/scaler.py
      - src/model_training/train.py
      - src/shared/config/config_gold.py
      - src/shared/config/config_logging.py
      - src/shared/config/config_training.py
      - src/shared/utils.py
      - data/gold_engineered_data/processed/train.parquet
      - data/gold_engineered_data/processed/validation.parquet
    params:
      - training_pipeline
      - mlflow_params
